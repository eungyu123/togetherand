name: Deploy with Rollback

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/nestjs-app

            # í˜„ì¬ ì»¤ë°‹ í•´ì‹œ ì €ì¥ (ë¡¤ë°±ìš©)
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "í˜„ì¬ ì»¤ë°‹: $CURRENT_COMMIT"

            # Git pullë¡œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main
            NEW_COMMIT=$(git rev-parse HEAD)
            echo "ìƒˆ ì»¤ë°‹: $NEW_COMMIT"

            # ì´ì „ ì´ë¯¸ì§€ ë°±ì—… (ë¡¤ë°±ìš©)
            docker tag nestjs-app_app:latest nestjs-app_app:backup-$(date +%Y%m%d_%H%M%S) || true

            # Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            docker-compose -f docker-compose.yml down -v

            # ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¹Œë“œ
            docker-compose -f docker-compose.yml build --no-cache

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker-compose -f docker-compose.yml up -d

            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            docker-compose -f docker-compose.yml exec -T app npm run migration:run

            # Nginx ì¬ì‹œì‘
            sudo systemctl restart nginx

            # ë°°í¬ ì™„ë£Œ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker-compose -f docker-compose.yml ps

            # í—¬ìŠ¤ì²´í¬ (3íšŒ ì‹œë„)
            for i in {1..3}; do
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/3..."
              if curl -f https://api.togetherand.site/health; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                break
              else
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ($i/3)"
                if [ $i -eq 3 ]; then
                  echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œì‘..."
                  # ë¡¤ë°± ë¡œì§
                  docker-compose -f docker-compose.yml down
                  docker tag nestjs-app_app:backup-$(date +%Y%m%d_%H%M%S) nestjs-app_app:latest || true
                  docker-compose -f docker-compose.yml up -d
                  sudo systemctl restart nginx
                  echo "ğŸ”„ ë¡¤ë°± ì™„ë£Œ"
                  exit 1
                fi
                sleep 10
              fi
            done
